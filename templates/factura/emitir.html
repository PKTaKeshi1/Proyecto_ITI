{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
  <h3 class="mb-3">Emitir Factura para Venta #{{ venta[0] }}</h3>

  <!-- Mensajes Flash -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Alerta personalizada JS -->
  <div id="alertaFactura" class="alert alert-danger d-none mt-3" role="alert"></div>

  {% if ya_facturada %}
    <div class="alert alert-warning" role="alert">
      Esta venta ya ha sido facturada. No puedes emitir otra factura para ella.
    </div>
  {% endif %}

  <form method="POST" onsubmit="return validarFactura()" class="card p-4 shadow-sm">
    <div class="mb-3">
      <label class="form-label">Cliente</label>
      <input type="text" class="form-control" value="{{ venta[1] }}" disabled>
    </div>

    <div class="mb-3">
      <label class="form-label">Vendedor</label>
      <input type="text" class="form-control" value="{{ venta[2] }}" disabled>
    </div>

    <div class="mb-3">
      <label class="form-label">Total</label>
      <input type="text" class="form-control" value="{{ venta[3] }} {{ '%.2f'|format(venta[4]) }}" disabled>
    </div>

    <!-- Tipo de comprobante fijo como "Factura" -->
    <input type="hidden" name="tipo_comprobante" value="1">

    <div class="mb-3">
      <label class="form-label">Serie</label>
      <input type="text" name="serie" id="serie" class="form-control" placeholder="Ej: F001"
             maxlength="4" pattern="[A-Za-z0-9]{1,4}" required {% if ya_facturada %}disabled{% endif %}>
    </div>

    <div class="mb-3">
      <label class="form-label">Número</label>
      <input type="text" name="numero" id="numero" class="form-control" placeholder="Ej: 000123"
             maxlength="6" pattern="[0-9]{1,6}" required {% if ya_facturada %}disabled{% endif %}>
    </div>

    <div class="mb-3">
      <label class="form-label">Moneda</label>
      <select name="id_moneda" id="id_moneda" class="form-select" required {% if ya_facturada %}disabled{% endif %}>
        <option value="">Seleccione...</option>
        {% for moneda in monedas %}
          <option value="{{ moneda[0] }}">{{ moneda[1] }} ({{ moneda[2] }})</option>
        {% endfor %}
      </select>
    </div>

    <div class="d-flex justify-content-between">
      <a href="{{ url_for('venta.listar_ventas') }}" class="btn btn-secondary">Cancelar</a>
      <button type="submit" class="btn btn-success" {% if ya_facturada %}disabled{% endif %}>
        Emitir Factura
      </button>
    </div>
  </form>
</div>

<script>
  function mostrarAlerta(mensaje) {
    const alerta = document.getElementById("alertaFactura");
    alerta.textContent = mensaje;
    alerta.classList.remove("d-none");
    setTimeout(() => alerta.classList.add("d-none"), 5000);
  }

  function validarFactura() {
    const serie = document.getElementById("serie");
    const numero = document.getElementById("numero");
    const idMoneda = document.getElementById("id_moneda");

    if (!serie.value.trim()) {
      mostrarAlerta("El campo Serie no puede estar vacío.");
      return false;
    }

    if (!numero.value.trim()) {
      mostrarAlerta("El campo Número no puede estar vacío.");
      return false;
    }

    if (!idMoneda.value) {
      mostrarAlerta("Debe seleccionar una moneda.");
      return false;
    }

    return true;
  }
</script>
{% endblock %}
